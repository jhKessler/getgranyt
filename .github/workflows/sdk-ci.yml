# =====================================================
# Granyt SDK - CI/CD Pipeline
# =====================================================
# 1. Runs linting and tests on PRs and pushes
# 2. Publishes to TestPyPI on pushes to main/staging
# 3. Publishes to PyPI on version tags
# =====================================================

name: SDK CI/CD

on:
  pull_request:
    branches:
      - main
      - staging
    paths:
      - 'granyt-sdk/**'
      - '.github/workflows/sdk-ci.yml'
  push:
    branches:
      - main
      - staging
      - dev
    tags:
      - 'sdk-v*.*.*'
    paths:
      - 'granyt-sdk/**'
      - '.github/workflows/sdk-ci.yml'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      publish_to:
        description: 'Where to publish'
        required: false
        type: choice
        options:
          - none
          - testpypi
          - pypi
        default: none

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =====================================================
  # Setup Matrix
  # =====================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      python-versions: ${{ steps.set-versions.outputs.versions }}
    steps:
      - id: set-versions
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == refs/tags/sdk-v* ]]; then
            echo "versions=[\"3.10\", \"3.11\", \"3.12\"]" >> $GITHUB_OUTPUT
          else
            echo "versions=[\"3.12\"]" >> $GITHUB_OUTPUT
          fi

  # =====================================================
  # Lint
  # =====================================================
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./granyt-sdk
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-path: './granyt-sdk/pyproject.toml'

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run linter (black)
        run: uv run black --check src/

      - name: Run import sorter (isort)
        run: uv run isort --check-only src/

      - name: Run type checker (mypy)
        run: uv run mypy src/

  # =====================================================
  # Test
  # =====================================================
  test:
    needs: [setup, lint]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./granyt-sdk

    strategy:
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python-versions) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-path: './granyt-sdk/pyproject.toml'

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run tests
        run: uv run pytest --cov=granyt_sdk --cov-report=xml

  # =====================================================
  # Build Package
  # =====================================================
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref != 'refs/heads/dev'
    defaults:
      run:
        working-directory: ./granyt-sdk

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-path: './granyt-sdk/pyproject.toml'

      - name: Set up Python
        run: uv python install 3.12

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/sdk-v* ]]; then
            # Release tag: extract version from tag (sdk-v1.2.3 -> 1.2.3)
            VERSION="${GITHUB_REF#refs/tags/sdk-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building release version: $VERSION"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch: release candidate
            BASE_VERSION=$(grep 'version = ' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION="${BASE_VERSION}rc${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building release candidate: $VERSION"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            # Staging branch: dev version
            BASE_VERSION=$(grep 'version = ' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
            VERSION="${BASE_VERSION}.dev${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building dev version: $VERSION"
          else
            # PR or other: use base version
            VERSION=$(grep 'version = ' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building version: $VERSION"
          fi

      - name: Update version in pyproject.toml
        run: |
          sed -i "s/^version = .*/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
          echo "Updated pyproject.toml:"
          grep "version = " pyproject.toml

      - name: Build package
        run: uv build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: granyt-sdk/dist/
          retention-days: 7

      - name: Build summary
        run: |
          echo "## ðŸ“¦ SDK Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Publish to TestPyPI (staging/main branches)
  # =====================================================
  publish-testpypi:
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_to == 'testpypi')
    
    environment: testpypi
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true  # Don't fail if version already exists

      - name: Publish summary
        run: |
          echo "## ðŸ§ª Published to TestPyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ granyt-sdk==${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Publish to PyPI (version tags only)
  # =====================================================
  publish-pypi:
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/sdk-v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_to == 'pypi')
    
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Publish summary
        run: |
          echo "## ðŸš€ Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install granyt-sdk==${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
