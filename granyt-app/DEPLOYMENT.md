# ğŸš€ Granyt Deployment Guide

This guide covers deploying Granyt in production environments.

## Table of Contents

- [Installation Paths](#installation-paths)
  - [1. Install Script](#1-install-script)
  - [2. Official Docker Compose](#2-official-docker-compose)
  - [3. Custom Deployment](#3-custom-deployment)
- [Environment Variable Reference](#environment-variable-reference)
  - [Official Docker Compose (.env file)](#official-docker-compose-env-file)
  - [Container Environment (Direct)](#container-environment-direct)
- [Docker Compose Detailed Guide](#docker-compose-detailed-guide)
- [Kubernetes Detailed Guide](#kubernetes-detailed-guide)
- [Version Management](#version-management)
- [Updating](#updating)
- [Reverse Proxy Setup](#reverse-proxy-setup)
- [Backup & Restore](#backup--restore)
- [Troubleshooting](#troubleshooting)

---

## Installation Paths

### 1. Install Script

The easiest way to deploy Granyt is using our interactive installation wizard:

```bash
curl -fsSL https://granyt.dev/install.sh | sh
```

Or download and run manually:

```bash
curl -O https://granyt.dev/install.sh
chmod +x install.sh
./install.sh
```

ğŸ“œ **[View the install script source](scripts/install.sh)**

The install wizard will:
1. âœ… Check for Docker (and optionally install it)
2. âœ… Download the required Docker Compose files
3. âœ… Help you set required environment variables
4. âœ… Automatically generate secure secrets
5. âœ… Start Granyt containers

**Options:**
- `--help` - Show help message
- `--dry-run` - Preview what would be done without making changes

---

### 2. Official Docker Compose

For users who want to use our pre-configured stack including a managed PostgreSQL database. This method uses a `.env` file to configure the entire stack.

1. **Download the compose file:**
   ```bash
   curl -O https://raw.githubusercontent.com/jhkessler/getgranyt/main/granyt-app/docker-compose.yml
   ```
2. **Configure your environment:** Create a `.env` file with the following variables:


| Variable | Description | Default / Requirement |
|----------|-------------|----------------------|
| **Database** | | |
| `POSTGRES_PASSWORD` | Password for the bundled database | **Required** |
| `POSTGRES_USER` | Database username | `granyt` |
| `POSTGRES_DB` | Database name | `granyt` |
| **Authentication** | | |
| `BETTER_AUTH_SECRET` | 32+ char key for session encryption | **Required** |
| `BETTER_AUTH_URL` | The public URL of your instance | **Required** |
| **Application** | | |
| `GRANYT_VERSION` | Docker image version to use | `latest` |
| `APP_PORT` | Host port to expose the UI on | `3000` |
| `NODE_ENV` | Application environment | `production` |
| `LOG_LEVEL` | Logging verbosity (debug, info, warn, error) | `info` |
| **Email (SMTP)** | | |
| `SMTP_HOST` | SMTP server hostname | - |
| `SMTP_PORT` | SMTP server port | `587` |
| `SMTP_USER` | SMTP username | - |
| `SMTP_PASSWORD` | SMTP password | - |
| `SMTP_FROM_EMAIL` | Sender email address | - |
| `SMTP_FROM_NAME` | Sender display name | `Granyt Alerts` |
| `SMTP_SECURE` | Use TLS/SSL (`true`/`false`) | `true` |
| **Email (Resend)** | | |
| `GRANYT_RESEND_API_KEY` | Resend API key | - |
| `RESEND_FROM_EMAIL` | Resend sender email | - |
| `RESEND_FROM_NAME` | Resend sender name | - |
| **Notifications** | | |
| `GRANYT_WEBHOOK_URL` | Global webhook endpoint URL | - |
| `GRANYT_WEBHOOK_SECRET` | Secret for signing webhook requests | - |

   *Note: The `DATABASE_URL` is automatically generated by Docker Compose using your `POSTGRES_PASSWORD`.*

3. **Start the stack:** `docker compose up -d`.

---

### 3. Custom Deployment (Kubernetes & Docker)

For advanced users deploying to Kubernetes, ECS, or using an external database (RDS, Supabase). You must provide the following variables directly to the both the app and migrations container environment:


| Variable | Description | Format / Requirement |
|----------|-------------|----------------------|
| **Core** | | |
| `DATABASE_URL` | Full Postgres connection string | **Required** (`postgresql://...`) |
| `BETTER_AUTH_SECRET` | 32+ char key for session encryption | **Required** |
| `BETTER_AUTH_URL` | Auth trusted origin URL | **Required** |
| `NEXT_PUBLIC_APP_URL` | Public app URL for dashboard links | **Required** (Should match `BETTER_AUTH_URL`) |
| `NODE_ENV` | Application environment | `production` |
| `PORT` | Container internal port | `3000` |
| `LOG_LEVEL` | Logging verbosity | `info` |
| **Email (SMTP)** | | |
| `SMTP_HOST` | SMTP server hostname | - |
| `SMTP_PORT` | SMTP server port | `587` |
| `SMTP_USER` | SMTP username | - |
| `SMTP_PASSWORD` | SMTP password | - |
| `SMTP_FROM_EMAIL` | Sender email address | - |
| `SMTP_FROM_NAME` | Sender display name | `Granyt Alerts` |
| `SMTP_SECURE` | Use TLS/SSL (`true`/`false`) | `true` |
| **Email (Resend)** | | |
| `GRANYT_RESEND_API_KEY` | Resend API key | - |
| `RESEND_FROM_EMAIL` | Resend sender email | - |
| `RESEND_FROM_NAME` | Resend sender name | - |
| **Notifications** | | |
| `GRANYT_WEBHOOK_URL` | Global webhook endpoint URL | - |
| `GRANYT_WEBHOOK_SECRET` | Secret for signing webhook requests | - |
| **Client Prefixed** | | |
| `NEXT_PUBLIC_GRANYT_MODE` | App mode (APP, DOCS, DEV) | `APP` |
| `NEXT_PUBLIC_DOCS_URL` | Base URL for documentation | `/docs` |

---
## Kubernetes Guide

For Kubernetes deployments, use the Docker images directly with your preferred orchestration method.

> ğŸ“‹ Make sure to configure all [Required Variables](#3-custom-deployment-kubernetes--docker) in your Kubernetes secrets.

### Docker Images

| Image | Purpose |
|-------|---------|
| `ghcr.io/jhkessler/granyt-app:latest` | Main application |
| `ghcr.io/jhkessler/granyt-app:latest-migrations` | Database migrations (init container) |

### Example Deployment

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: granyt-config
data:
  NODE_ENV: "production"
  NEXT_PUBLIC_APP_URL: "https://granyt.example.com"
  # Add other non-secret environment variables here
---
apiVersion: v1
kind: Secret
metadata:
  name: granyt-secrets
type: Opaque
stringData:
  # Required - see Custom Deployment section above
  database-url: "postgresql://granyt:YOUR_PASSWORD@postgres:5432/granyt?schema=public"
  better-auth-secret: "your-32-char-secret-key-here"
  better-auth-url: "https://granyt.example.com"
  # Optional - SMTP settings for email alerts
  smtp-host: ""
  smtp-user: ""
  smtp-password: ""
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: granyt-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: granyt
  template:
    metadata:
      labels:
        app: granyt
    spec:
      initContainers:
        # Run migrations before starting the app
        - name: migrations
          image: ghcr.io/jhkessler/granyt-app:latest-migrations
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: granyt-secrets
                  key: database-url
      containers:
        - name: app
          image: ghcr.io/jhkessler/granyt-app:latest
          ports:
            - containerPort: 3000
          env:
            # From Secrets
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: granyt-secrets
                  key: database-url
            - name: BETTER_AUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: granyt-secrets
                  key: better-auth-secret
            - name: BETTER_AUTH_URL
              valueFrom:
                secretKeyRef:
                  name: granyt-secrets
                  key: better-auth-url
            # From ConfigMap
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: granyt-config
                  key: NODE_ENV
            - name: NEXT_PUBLIC_APP_URL
              valueFrom:
                configMapKeyRef:
                  name: granyt-config
                  key: NEXT_PUBLIC_APP_URL
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 40
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: granyt-service
spec:
  selector:
    app: granyt
  ports:
    - port: 80
      targetPort: 3000
  type: ClusterIP
```

---

## Version Management

### Image Tags

Granyt publishes multiple image tags:

| Tag | Description | Use Case |
|-----|-------------|----------|
| `latest` | Most recent build from main | Production (recommended) |
| `dev` | Most recent build from dev branch | Testing pre-release |
| `1.0.0` | Specific version | Production (pinned) |
| `1.0` | Major.minor version | Auto-update patch versions |
| `sha-abc123` | Git commit SHA | Debugging specific builds |
| `dev-abc123` | Dev branch commit SHA | Testing specific dev builds |

### Pinning Versions (Recommended for Production)

In your `.env` file (see [Official Docker Compose variables](#official-docker-compose-env-file)):

```bash
# Pin to a specific version
GRANYT_VERSION=1.0.0
```

This ensures:
- Predictable deployments
- No surprise breaking changes
- Controlled update process

## Updating

> â„¹ï¸ **Note**: Simply restarting containers (`docker compose restart`) will **not** update to newer versions. You must explicitly pull the latest images as shown below.

Database migrations run automatically on startup. The migrations container will apply any pending schema changes before the app starts, ensuring your database is always in sync with the application version.

### Update to Latest

```bash
# Pull latest images
docker compose pull

# Restart with new images (migrations run automatically)
docker compose up -d
```

### Update to Specific Version

1. Edit `.env` (see [Official Docker Compose variables](#official-docker-compose-env-file)):
   ```bash
   GRANYT_VERSION=1.1.0
   ```

2. Pull and restart:
   ```bash
   docker compose pull
   docker compose up -d
   ```

### Rollback

1. Edit `.env` with the previous version:
   ```bash
   GRANYT_VERSION=1.0.0
   ```

2. Restart:
   ```bash
   docker compose up -d
   ```

> âš ï¸ **Note**: Database migrations are forward-only. Rolling back the app version won't revert database changes and possibly break your deployment.
### Reset Everything

> âš ï¸ **Warning**: This will delete all data!

```bash
# Stop and remove everything
docker compose down -v

# Start fresh
docker compose up -d
```
---
## Support

- ğŸ“– [Documentation](https://github.com/jhkessler/getgranyt)
- ğŸ› [Issue Tracker](https://github.com/jhkessler/getgranyt/issues)
- ğŸ’¬ [Discussions](https://github.com/jhkessler/getgranyt/discussions)
