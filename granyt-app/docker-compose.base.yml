# =====================================================
# Granyt App - Base Docker Compose Configuration
# =====================================================
#
# This file contains shared service definitions used by:
# - docker-compose.development.yml (database only)
# - docker-compose.standalone.yml (full stack, exposed ports)
# - docker-compose.production.yml (full stack, no exposed ports)
#
# DO NOT use this file directly. Use one of the above files instead.
# =====================================================

# =========================
# YAML Anchors for reuse
# =========================
x-postgres-env: &postgres-env
  POSTGRES_USER: ${POSTGRES_USER:-granyt}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
  POSTGRES_DB: ${POSTGRES_DB:-granyt}

x-database-url: &database-url
  DATABASE_URL: postgresql://${POSTGRES_USER:-granyt}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-granyt}?schema=public

x-app-env: &app-env
  # Database
  <<: *database-url
  
  # Authentication (Better Auth) - REQUIRED
  BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:?BETTER_AUTH_SECRET is required}
  BETTER_AUTH_URL: ${BETTER_AUTH_URL:?BETTER_AUTH_URL is required}
  NEXT_PUBLIC_APP_URL: ${BETTER_AUTH_URL:?BETTER_AUTH_URL is required}
  
  # Application
  NODE_ENV: production
  
  # Email Notifications (Optional - for alerts)
  SMTP_HOST: ${SMTP_HOST:-}
  SMTP_PORT: ${SMTP_PORT:-587}
  SMTP_USER: ${SMTP_USER:-}
  SMTP_PASSWORD: ${SMTP_PASSWORD:-}
  SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}
  SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Granyt Alerts}
  SMTP_SECURE: ${SMTP_SECURE:-true}

  # Analytics (Optional)
  NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY:-}
  NEXT_PUBLIC_POSTHOG_HOST: ${NEXT_PUBLIC_POSTHOG_HOST:-https://us.i.posthog.com}

# =========================
# Service definitions
# =========================
services:
  # =========================
  # PostgreSQL Database
  # =========================
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      <<: *postgres-env
    volumes:
      - postgres-data:/var/lib/postgresql/data
    shm_size: 128mb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-granyt} -d ${POSTGRES_DB:-granyt}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - granyt-network

  # =========================
  # Database Migrations
  # =========================
  migrations:
    image: ghcr.io/jhkessler/granyt-app:${GRANYT_VERSION:-latest}-migrations
    environment:
      <<: *database-url
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - granyt-network
    restart: "no"

  # =========================
  # Next.js Application
  # =========================
  app:
    image: ghcr.io/jhkessler/granyt-app:${GRANYT_VERSION:-latest}
    restart: unless-stopped
    environment:
      <<: *app-env
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - granyt-network

# =========================
# Volumes
# =========================
volumes:
  postgres-data:
    name: granyt-postgres-data

# =========================
# Networks
# =========================
networks:
  granyt-network:
    name: granyt-network
    driver: bridge
