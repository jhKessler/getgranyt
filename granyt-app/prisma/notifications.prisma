// Notification settings and channel configuration

enum NotificationType {
  ALL_ALERTS
  NULL_OCCURRENCE_ALERT
  SCHEMA_CHANGE_ALERT
  ROW_COUNT_DROP_ALERT
  ALL_ERRORS
  NEW_ERRORS_ONLY
}

enum ChannelType {
  SMTP
  RESEND
  WEBHOOK
}

// Per-organization channel configuration
model OrganizationChannelConfig {
  id              String      @id @default(cuid())
  organizationId  String
  channelType     ChannelType
  enabled         Boolean     @default(true)
  
  // JSON config specific to each channel type
  // SMTP: { host, port, user, password, fromEmail, fromName, secure }
  // Resend: { apiKey, fromEmail, fromName }
  // Webhook: { url, headers, secret }
  config          Json?
  
  // Last test result
  lastTestAt      DateTime?
  lastTestSuccess Boolean?
  lastTestError   String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, channelType])
  @@map("organization_channel_config")
}

// Notification preferences per user (per notification type)
model UserNotificationSettings {
  id                String           @id @default(cuid())
  userId            String
  notificationType  NotificationType
  enabled           Boolean          @default(true)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@map("user_notification_settings")
}

// User-level email notification filters (applies across all notification types)
model UserNotificationFilters {
  id                 String   @id @default(cuid())
  userId             String   @unique

  // "all" = receive emails for all environments
  // "default_only" = only receive emails for the org's default environment
  environmentFilter  String   @default("all")

  // true = receive emails for manual runs
  // false = suppress emails for manual runs
  includeManualRuns  Boolean  @default(true)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_filters")
}
